import type { NextPage } from "next";
import Head from "next/head";
import { useState } from "react";

import { addMonths } from "date-fns";
import {
  Container,
  Heading,
  Paragraph,
  Flex,
  Input,
  Box,
  Link,
} from "theme-ui";

import { GetStaticProps, GetStaticPropsContext } from "next";
import gciCalculator from "../utils/calculator";

type HomeProps = {
  hashRate: number;
  totalSupply: number;
};

const Home: NextPage<HomeProps> = (props) => {
  const [btc, setBtc] = useState(100);

  // const [hashRate, setHashRate] = useState(props.hashRate);

  // const [lostCoins, setLostCoins] = useState(3000000);

  const {
    hashRateToMine,
    percentOfSupply,
    s19Count,
    effectiveTotal,
    s19Hashrate,
    lostCoins,
  } = gciCalculator({
    btcHoldings: btc,
    totalSupply: props.totalSupply,
    hashRate: props.hashRate,
  });

  return (
    <>
      <Head>
        <title>Green your Bitcoin</title>
        {/* <meta name="description" content="Generated by create next app" /> */}
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <Heading
        sx={{
          color: "primary",
          fontFamily: "heading",
          fontSize: "40px",
          my: "5rem",
        }}
      >
        Green your Bitcoin
      </Heading>
      {/* <Paragraph sx={{ pb: 20 }}>
        This is a demo, the calculations are not yet accurate
      </Paragraph> */}
      <Paragraph sx={{ my: 20 }}>
        What is this? Read the{" "}
        <Link
          target={"_blank"}
          rel="noreferrer"
          href="https://www.resistance.money/green/"
        >
          white paper
        </Link>{" "}
        at resistance.money to learn more.
      </Paragraph>
      <Paragraph>Your BTC holdings:</Paragraph>
      <Flex sx={{ alignItems: "center", mb: 20 }}>
        <Input
          sx={{
            width: 200,
          }}
          min={0}
          max={props.totalSupply}
          type="number"
          value={btc}
          onChange={(e) => setBtc(parseFloat(e.currentTarget.value))}
        />
        <Paragraph ml={10}>BTC</Paragraph>
      </Flex>
      <Flex sx={{ mb: 20 }}>
        <Box sx={{ mr: 20 }}>
          <Paragraph>Total BTC supply:</Paragraph>
          <Paragraph>{props.totalSupply.toLocaleString()}</Paragraph>
        </Box>
        <Box>
          <Paragraph>Coins assumed lost:</Paragraph>
          <Paragraph>{lostCoins.toLocaleString()}</Paragraph>
        </Box>
      </Flex>
      <Paragraph>Effective total BTC supply:</Paragraph>
      <Heading sx={{ mb: 20 }}>{effectiveTotal.toLocaleString()}</Heading>
      <Paragraph>Of which you hold:</Paragraph>
      <Heading sx={{ mb: 20 }}>
        <b>{percentOfSupply}%</b>
      </Heading>

      <Paragraph>3 month average global hashrate:</Paragraph>
      <Heading>{props.hashRate.toLocaleString()} TH/s</Heading>
      <Paragraph sx={{ mt: 20 }}>Your holdings incentivise:</Paragraph>
      <Heading>
        <b>{hashRateToMine.toLocaleString()}</b> TH/s
      </Heading>
      <Paragraph>
        Or {Math.round(s19Count).toLocaleString()} Antminer s19 Pros at{" "}
        {s19Hashrate} TH/s
      </Paragraph>
      <Paragraph sx={{ mt: 20 }}>
        To ensure your BTC holdings are carbon neutral you can mine this amount
        or more with renewable energy, or purchase an equivalent Green
        Co-investment (GCI) instrument.
      </Paragraph>
      <Paragraph sx={{ fontSize: 1, mt: 30 }}>
        Hashrate from{" "}
        <Link
          target={"_blank"}
          rel="noreferrer"
          href="http://twitter.com/glassnode"
        >
          @glassnode
        </Link>
        <br />
        Built by{" "}
        <Link
          target={"_blank"}
          rel="noreferrer"
          href="http://twitter.com/islandHODL"
        >
          @islandHODL
        </Link>
        <br />
        Inspired by{" "}
        <Link
          target={"_blank"}
          rel="noreferrer"
          href="https://twitter.com/thetrocro"
        >
          Troy Cross
        </Link>{" "}
        &amp;{" "}
        <Link
          target={"_blank"}
          rel="noreferrer"
          href="https://twitter.com/resistancemoney"
        >
          Andrew M. Bailey
        </Link>{" "}
        at{" "}
        <Link
          target={"_blank"}
          rel="noreferrer"
          href="https://www.resistance.money/green/"
        >
          Resistance.money
        </Link>
      </Paragraph>
    </>
  );
};
export const getStaticProps: GetStaticProps<HomeProps> = async () => {
  if (!process.env.GLASSNODE_API_KEY)
    return {
      props: {
        hashRate: 0,
        totalSupply: 0,
      },
    };

  const url = new URL(
    "https://api.glassnode.com/v1/metrics/mining/hash_rate_mean"
  );

  const params = {
    i: "1month",
    a: "btc",
    s: Math.round(addMonths(new Date(), -3).getTime() / 1000).toString(),
    api_key: process.env.GLASSNODE_API_KEY,
  };

  url.search = new URLSearchParams(params).toString();

  const getHashRate = await fetch(url.toString());

  console.log(params.s);

  const hashRate = await getHashRate.json();

  const averageHashRate = hashRate
    ? (hashRate as any[])
        .map((m) => m.v as number)
        .reduce((partial_sum, a) => partial_sum + a, 0) / 3
    : 0;

  console.log(hashRate, averageHashRate);

  const getTotalSupply = await fetch("https://blockchain.info/q/totalbc");
  const totalSupply = await getTotalSupply.json();

  return {
    props: {
      hashRate: averageHashRate ? averageHashRate / 1000000000000 : 0,
      totalSupply: totalSupply ? totalSupply / 100000000 : 21000000,
    },
    revalidate: 20,
  };
};

export default Home;
